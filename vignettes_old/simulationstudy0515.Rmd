---
title: "Progress Report"
author: "Shusei Eshima"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{GenSimDataLDA}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r warning=FALSE, message=FALSE, echo = FALSE}
# package_folder <- "/Users/Shusei/Dropbox/Study/Project/ImaiText/topicdict"
# setwd(package_folder)
# devtools::document() ; devtools::install() ; library(topicdict)
savepath <- "/Users/Shusei/Dropbox/Study/Project/ImaiText/topicdict/vignettes/"
iter_num <- 800
library(knitr)
knitr::opts_chunk$set(comment = "")
```


```{r, warning=FALSE, message=FALSE}
library(topicdict)
library(purrr)
library(quanteda)
library(tibble)
library(ggplot2)
library(dplyr)
library(topicmodels)
```

# Prepare Functions
```{r warning=FALSE, message=FALSE, include=FALSE}
source("create_simulation_data.R")

# Use a part of seed words
use_part_of_seed <- function(x, use=1:5){
  res <- x[use] # use part of seed
  return(res)
}
```

Create model function:
```{r, warning=FALSE, message=FALSE}
create_model <- function(docs, seed_list, extra_k){
  set.seed(225)
  names(seed_list) <- 1:length(seed_list)
  dict <- quanteda::dictionary(seed_list)
  model <- topicdict_model(docs,
               dict = dict, extra_k = extra_k,
               remove_numbers = FALSE, 
               remove_punct = TRUE,
               remove_symbols = TRUE,
               remove_separators = TRUE)

  return(model)
}
```

```{r, warning=FALSE, message=FALSE}
# Check dispersion
tidy_seededlda_out <- function(model, res, n=15, show=F){
  # Create a nested data frame which contains W and Z
  post <- topicdict::posterior(res)
  topwords <- top_terms(post, n=n)
  topwords <- data.frame(topwords)
  colnames(topwords) <- paste0("EstTopic", 1:ncol(topwords))
  topwords %>%
    tidyr::gather(., key=EstTopic, value=Word) %>%
    mutate(Word = gsub("\\s.*$", "", Word)) -> otidy

  if(show){
    num_seededtopic <- length(model$seeds)
    print(top_terms(post, n)[, 1:num_seededtopic])
  }

  return(otidy)
}


list_to_tibble <- function(lobj){
  # Flatten list and get a tibble
  obj_len <- lobj %>% map(length) %>% flatten_int()
  element <- lobj %>% flatten_chr()

  tibble(SeedTopic = rep(paste0("EstTopic", 1:length(obj_len)), obj_len),
         Word=element
         ) -> res
  return(res)
}

count_appearence_list <- function(otidy, lobj){
  all_words <- lobj %>% flatten_chr()
  SeedTopicName <- paste0("EstTopic", 1:length(lobj))

  otidy %>% 
    right_join(., list_to_tibble(get("lobj")), by="Word") %>%
    mutate(count = ifelse(is.na(EstTopic), 0, 1)) %>%
    group_by(Word, SeedTopic) %>%
    summarize(count = sum(count)) -> organized


  organized %>%
    ggplot(., aes(x=factor(count))) +
    geom_histogram(stat="count") +
    xlab("Number of Topics") + ylab("Count") + ggtitle("Words Split across Topics") +
    theme_bw(base_size=15) +
    theme(plot.title = element_text(hjust = 0.5)) -> g1

  organized %>%
    ggplot(., aes(x=factor(count))) +
    geom_histogram(stat="count") +
    facet_wrap(~ SeedTopic, ncol=3) +
    xlab("Number of Topics") + ylab("Count") + ggtitle("Words Split across Topics") +
    theme_bw(base_size=15) +
    theme(plot.title = element_text(hjust = 0.5)) -> g2

  # Only check topics with seed
  otidy %>% 
    filter(EstTopic %in% get("SeedTopicName")) %>%
    right_join(., list_to_tibble(get("lobj")), by="Word") %>%
    mutate(count = ifelse(is.na(EstTopic), 0, 1)) %>%
    group_by(Word, SeedTopic) %>%
    summarize(count = sum(count)) -> organized_

  organized_ %>%
    ggplot(., aes(x=factor(count))) +
    geom_histogram(stat="count") +
    facet_wrap(~ SeedTopic, ncol=3) +
    xlab("Number of Topics") + ylab("Count") + ggtitle("Words Split across Topics\n(Only topics with keywords)") +
    theme_bw(base_size=15) +
    theme(plot.title = element_text(hjust = 0.5)) -> g3

  return(list(g1, g2, g3))
}
```

```{r, warning=FALSE, message=FALSE}
library(tm)

get_lda_result <- function(doc_folder, seed_list, iter_num, k, topicvec=1:k, show_n=15){

  # Prepare Data
  corpus <- Corpus(DirSource(doc_folder))
  strsplit_space_tokenizer <- function(x)
      unlist(strsplit(as.character(x), "[[:space:]]+"))

  dtm <- DocumentTermMatrix(corpus,
                           control = list(tokenize=strsplit_space_tokenizer, 
                           stopwords = F, tolower = T, 
                           stemming = F, wordLengths = c(1, Inf)))

  lda <- LDA(dtm, k = k, control = list(seed = 225, iter=iter_num), method="Gibbs")


  all_words <- seed_list %>% flatten_chr()

  tidytext::tidy(lda) %>%
    group_by(topic) %>%
    top_n(show_n, beta) %>%
    rename(topics = topic, Word = term) %>%
    select(-beta) %>%
    right_join(., list_to_tibble(get("seed_list")), by="Word") %>%
    mutate(count = ifelse(is.na(topics), 0, 1)) %>%
    group_by(Word, SeedTopic) %>%
    summarize(count = sum(count)) -> organized


  organized %>%
    ggplot(., aes(x=factor(count))) +
    geom_histogram(stat="count") +
    xlab("Number of Topics") + ylab("Count") + ggtitle("Words Split across Topics") +
    theme_bw(base_size=15) +
    theme(plot.title = element_text(hjust = 0.5)) -> g1

  organized %>%
    ggplot(., aes(x=factor(count))) +
    geom_histogram(stat="count") +
    facet_wrap(~ SeedTopic, ncol=3) +
    xlab("Number of Topics") + ylab("Count") + ggtitle("Words Split across Topics") +
    theme_bw(base_size=15) +
    theme(plot.title = element_text(hjust = 0.5)) -> g2

  return(list(g1, g2))
}
```


# Check dispersion with similation data

# True K = 15
```{r, warning=FALSE, message=FALSE, fig.width=5, fig.height=5}
data_folder <- tempfile()
seed_list <- create_sim_data(saveDir=paste0(data_folder, "Sim1"), D=1000, K=15, TotalV=3000, alpha=0.1, beta_r=0.1, beta_s=0.1, p=c(rep(0.2, 5),rep(0.12, 5),rep(0.05, 5)), lambda=200, seeds_len=5)
seed_list <- lapply(seed_list, function(x){tolower(x)})
seed_list_full <- seed_list
seed_list <- seed_list_full[c(3,4,7,8,14,15)]
```


```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
doc_folder <- paste0(data_folder, "Sim1", "/W")
docs <- list.files(doc_folder, pattern = "*.txt", full.names = TRUE)
explore_ <- explore(docs,
             remove_numbers = FALSE, # For simulation, make it false
             remove_punct = TRUE,
             remove_symbols = TRUE,
             remove_separators = TRUE)
explore_$visualize_dict_prop(seed_list)
```

## K = 15
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=9)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=15)
```

## K = 25
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=19)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=25)
```

## K = 50
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=44)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=50)
```

## K = 100
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=94)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=100)
```

## K = 25, only middle proportion

```{r, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=6.5}
seed_list <- seed_list_full[c(3,4,5)]
explore_$visualize_dict_prop(seed_list)
```

```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=22)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=25)
```

## K = 25, only low proportion

```{r, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=6.5}
seed_list <- seed_list_full[c(11,14,15)]
explore_$visualize_dict_prop(seed_list)
```

```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=22)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=25)
```

## K = 25, No Contamination
```{r, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=6.5}
seed_list <- seed_list_full[c(6,5,7,9,12)]
explore_$visualize_dict_prop(seed_list)
```

```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=20)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=25)
```

## Contamination 1, K = 25
```{r, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=6.5}
seed_list <- list(
                  c(seed_list_full[[6]][1:4],seed_list_full[[13]][2]),
                  c(seed_list_full[[5]][1:4],seed_list_full[[7]][2]),
                  c(seed_list_full[[7]][1:4], seed_list_full[[3]][2]),
                  c(seed_list_full[[9]][1:4], seed_list_full[[5]][2]),
                  c(seed_list_full[[12]][1:4], seed_list_full[[8]][2])
                  ) 
explore_$visualize_dict_prop(seed_list)
```

```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=20)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=25)
```

## Contamination 2, K = 25
```{r, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=6.5}
seed_list <- list(
                  c(seed_list_full[[6]][1:5]),
                  c(seed_list_full[[5]][1:4],seed_list_full[[7]][2]),
                  c(seed_list_full[[3]][1:3], seed_list_full[[3]][2], seed_list_full[[5]][2]),
                  c(seed_list_full[[9]][1:3], seed_list_full[[5]][3], seed_list_full[[7]][3]),
                  c(seed_list_full[[12]][1:3], seed_list_full[[8]][2], seed_list_full[[6]][2])
                  ) 
explore_$visualize_dict_prop(seed_list)
```

```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=20)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res), seed_list)
```

# True K = 45
```{r, warning=FALSE, message=FALSE, fig.width=5, fig.height=5}
data_folder <- tempfile()
seed_list <- create_sim_data(saveDir=paste0(data_folder, "Sim1"), D=1000, K=45, TotalV=3000, alpha=0.1, beta_r=0.1, beta_s=0.1, p=c(rep(0.2, 15),rep(0.12, 15),rep(0.05, 15)), lambda=200, seeds_len=5)
seed_list <- lapply(seed_list, function(x){tolower(x)})
seed_list_full <- seed_list
seed_list <- seed_list_full[c(5,12,19,24,36,40)]
```


```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
doc_folder <- paste0(data_folder, "Sim1", "/W")
docs <- list.files(doc_folder, pattern = "*.txt", full.names = TRUE)
explore_ <- explore(docs,
             remove_numbers = FALSE, # For simulation, make it false
             remove_punct = TRUE,
             remove_symbols = TRUE,
             remove_separators = TRUE)
explore_$visualize_dict_prop(seed_list)
```

## K = 50
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=44)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=50)
```

## K = 80
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=74)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=80)
```

## K = 100
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=94)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=100)
```

## Contamination 1, K = 60
```{r, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=6.5}
seed_list <- list(
                  c(seed_list_full[[5]][1:4],seed_list_full[[45]][2]),
                  c(seed_list_full[[12]][1:4],seed_list_full[[33]][2]),
                  c(seed_list_full[[19]][1:4], seed_list_full[[16]][2]),
                  c(seed_list_full[[24]][1:4], seed_list_full[[21]][2]),
                  c(seed_list_full[[36]][1:4], seed_list_full[[9]][2])
                  ) 
explore_$visualize_dict_prop(seed_list)
```

```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=55)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=60)
```

## Contamination 2, K = 60
```{r, warning=FALSE, message=FALSE, fig.width=6.5, fig.height=6.5}
seed_list <- list(
                  c(seed_list_full[[5]][1:5]),
                  c(seed_list_full[[12]][1:4],seed_list_full[[9]][2]),
                  c(seed_list_full[[19]][1:3], seed_list_full[[22]][2], seed_list_full[[40]][2]),
                  c(seed_list_full[[24]][1:3], seed_list_full[[33]][3], seed_list_full[[28]][3]),
                  c(seed_list_full[[36]][1:3], seed_list_full[[12]][2], seed_list_full[[16]][2])
                  ) 
explore_$visualize_dict_prop(seed_list)
```

```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=55)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res), seed_list)
```


# Amy's Data Look in Detail
## Read Data
```{r, warning=FALSE, message=FALSE}
doc_folder <- paste0("/Users/Shusei/Dropbox/Study/My_Research/TreeStructuredTopicModel/Papers/replication/Catalinac/data/docs") # Data from original data Document-Term Matrix
docs <- list.files(doc_folder, pattern = "*.txt", full.names = TRUE)
explore_ <- explore(docs,
             remove_numbers = TRUE,
             remove_punct = TRUE,
             remove_symbols = TRUE,
             remove_separators = TRUE)
```

## Self-Selected Keywords
```{r, warning=FALSE, message=FALSE}
# Remove overlapping words for better comparison
seed_list <- list(c("農業 整備 漁業 開発 水産"), # agriculture, fishing industry
                  c("税 消費 暮らし 景気 税金"), # tax
                  c("介護 高齢 保険 長寿 健康"), # aging society
                  c("軍事 戦争 軍 自衛隊 平和"))
seed_list <- lapply(seed_list, function(x){strsplit(x, " ")[[1]]})
g <- explore_$visualize_dict_prop(seed_list)
g
ggsave("/Users/Shusei/Dropbox/Study/Project/ImaiText/topicdict/vignettes/Catalinac.pdf", g, width=5, height=4, family="Japan1GothicBBB")
```

## K + 1
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
# SeededLDA eight keywords
model <- create_model(docs, seed_list, extra_k=1)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res, show=T), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=6)
```


## K + 16
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
# SeededLDA eight keywords
model <- create_model(docs, seed_list, extra_k=16)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res, show=T), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=20)
```

## K + 46
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
# SeededLDA eight keywords
model <- create_model(docs, seed_list, extra_k=46)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res, show=T), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=50)
```

## Original Keywords
```{r, warning=FALSE, message=FALSE}
# Remove overlapping words for better comparison
topic52 <- c("農業 産業 整備 漁業 開発")
topic62 <- c("復興 連立 被災 災害 ひと")
topic63 <- c("政治 主義 自由 社会 民主")
topic20 <- c("税 消費 廃止 国民 日本")
topic58 <- c("企業 教育 中小 充実 図る")

seed_list <- list(topic52, topic62, topic63, topic20, topic58)
seed_list <- lapply(seed_list, function(x){strsplit(x, " ")[[1]]})
g <- explore_$visualize_dict_prop(seed_list)
g
ggsave("/Users/Shusei/Dropbox/Study/Project/ImaiText/topicdict/vignettes/Catalinac2.pdf", g, width=5, height=4, family="Japan1GothicBBB")
```


## k = 6 (K+1)
### Seeded LDA
```{r, warning=FALSE, message=FALSE, fig.width=9.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=1)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res, show=T), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=9.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=6)
```


## k = 15 (K+10)
### Seeded LDA
```{r, warning=FALSE, message=FALSE, fig.width=9.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=10)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res, show=T), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=9.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=15)
```

## k = 30 (K+25)
### Seeded LDA
```{r, warning=FALSE, message=FALSE, fig.width=9.5, fig.height=6.5}
model <- create_model(docs, seed_list, extra_k=25)
res <- topicdict_train(model, iter = iter_num)
count_appearence_list(tidy_seededlda_out(model, res, show=T), seed_list)
```

### Standard LDA
```{r, warning=FALSE, message=FALSE, fig.width=9.5, fig.height=6.5}
get_lda_result(doc_folder, seed_list, iter_num, k=30)
```

# New Visualization
```{r, warning=FALSE, message=FALSE}
diagnosis_topic_recovery_heatmap <- function(post, n=25, title_=T,
                        seed_list=NULL,
                        topicvec=c(), merge=list()){
  topwords <- top_terms(post, n=n)
  topwords <- data.frame(topwords)
  colnames(topwords) <- paste0("EstTopic", 1:ncol(topwords))

  topwords <- tidyr::gather(topwords, key=EstTopic, value=Word) %>%
                mutate(Word = gsub("\\s.*$", "", Word))

  topwords %>%
    mutate(RawWord = Word) %>%
    tidyr::separate(Word,
        into=c("word_id", "TrueTopic"),
        sep="t") %>%
    mutate(TrueTopic = paste0("True", as.character(TrueTopic))) -> res_

  merge_length <- length(merge)
  if(merge_length != 0){
    # Merge Topics
    for(i in 1:merge_length){
      m <- merge[[i]]
      mt <- paste0("True", m)

      res_ %>%
        mutate(TrueTopic=replace(TrueTopic, TrueTopic==mt[1], mt[3])) %>%
        mutate(TrueTopic=replace(TrueTopic, TrueTopic==mt[2], mt[3])) -> res_
    }
  }

  res_ %>%
    group_by(EstTopic, TrueTopic) %>%
    summarise(counts = n()) %>%
    ungroup() %>%
    group_by(EstTopic) %>% 
    mutate(topicsum = sum(counts)) %>%
    ungroup() %>%
    mutate(Proportion = counts / topicsum * 100) -> res_

  if(!is.null(seed_list)){
    # Use only topics with keywords
    num <- length(seed_list)
    seed_list_name <- paste0("EstTopic", 1:num)
    res_ %>%
      filter(EstTopic %in% get("seed_list_name")) -> res_
  }

  num <- length(unique(res_$EstTopic))
  if(is.null(topicvec)){
    res_ %>%
      group_by(EstTopic) %>%
      top_n(1, Proportion) %>%
      mutate(forranking = as.integer(gsub("EstTopic", "", EstTopic))) %>%
      arrange(forranking) %>%
      select(EstTopic) -> topicvec 
    topicvec <-  unique(as.integer(gsub("EstTopic", "", topicvec$EstTopic)))
  }else if(length(topicvec) != num){
    message("topicvec length does not match")
    topicvec <- 1:num
  }

  truenum <- length(unique(res_$TrueTopic))

  title <- paste0("Seeded LDA: Top ", as.character(n), " words")

  g <- ggplot(res_, aes(EstTopic, TrueTopic)) +
        geom_tile(aes(fill=Proportion)) + 
        scale_fill_gradient(limits=c(0, 100), low="#e8e8e8", high="#0072B2", name = "Proportion") +
        scale_x_discrete(limits = rev(paste0("EstTopic", topicvec))) +
        coord_flip() +
        scale_y_discrete(limits = paste0("True", 1:truenum)) +
        xlab("Estimated Topics") + ylab("True Topic") + theme_bw(base_size=13)
  
  if(title_){
    g <- g + ggtitle(title) +
        theme(plot.title = element_text(hjust = 0.5))
  }


  return(g)
}

```


```{r, warning=FALSE, message=FALSE}
library(grid)
library(gridExtra)
run_simulations <- function(trueK, estimatedK, seeds_len=6,
                            seed_only=F, seed_contamination=0){
  # Create Combinations
  combinations <- expand.grid(trueK, estimatedK)
  num_combinations <- nrow(combinations)

  # Run Simulations
  for(s in 1:num_combinations){
    trueK_ <- combinations[s, 1]
    estimatedK_ <- combinations[s, 2]

    # Create Data
    set.seed(225)
    data_folder <- tempfile()
    seed_list <- create_sim_data(saveDir=paste0(data_folder, "Sim1"), 
                                 D=1000, K=trueK_, TotalV=3000, alpha=0.1, 
                                 beta_r=0.1, beta_s=0.1, 
                                 p=rep(0.15, trueK_) + rnorm(trueK_, mean=0, sd=0.04), 
                                 lambda=200, seeds_len=seeds_len)
    seed_list <- lapply(seed_list, function(x){tolower(x)})

    # Seed contamination
    if(seed_contamination != 0){
      for(i in 1:seed_contamination){
        seed_list <- lapply(seed_list, function(x){
                      x[sample(1:seeds_len, 1)] <- seed_list[[sample(1:trueK_, 1)]][sample(1:seeds_len, 1)] 
                      return(x)
                      })
      }
    }

    # Fit the model
    extra_k_ <- estimatedK_ - length(seed_list)
    if(extra_k_ < 0){
      message("extra_k is negative, setting it to 0")
      extra_k_ <- 0
      seed_list <- seed_list[1:estimatedK_]
    }
    doc_folder <- paste0(data_folder, "Sim1", "/W")
    docs <- list.files(doc_folder, pattern = "*.txt", full.names = TRUE)
    model <- create_model(docs, seed_list, extra_k=extra_k_)
    res <- topicdict_train(model, iter = iter_num)
    post <- topicdict::posterior(res)

    if(seed_only){
      g <- diagnosis_topic_recovery_heatmap(post, 15, title_=F, seed_list=seed_list)
    }else{
      g <- diagnosis_topic_recovery_heatmap(post, 15, title_=F)
    }

    # Save
    saveRDS(g, file = paste0("/Users/Shusei/Dropbox/Study/Project/ImaiText/topicdict/vignettes/obj/", 
                            "fig_T", trueK_, "_E", estimatedK_, ".obj"))
    saveRDS(post, file = paste0("/Users/Shusei/Dropbox/Study/Project/ImaiText/topicdict/vignettes/obj/", 
                            "post_T", trueK_, "_E", estimatedK_, ".obj"))

    message(paste0("Done: ", s, "/", num_combinations))
  }
}

create_simulation_figure <- function(trueK, estimatedK, title_="Simulation Results"){
  # Create Combinations
  combinations <- expand.grid(trueK, estimatedK) %>%
                    arrange(rev(Var2)) 
  num_combinations <- nrow(combinations)

  # Load Data
  figures <- list()
  for(s in 1:num_combinations){
    trueK_ <- combinations[s, 1]
    estimatedK_ <- combinations[s, 2]

    figures[[s]] <- readRDS(file = paste0("/Users/Shusei/Dropbox/Study/Project/ImaiText/topicdict/vignettes/obj/", 
                            "fig_T", trueK_, "_E", estimatedK_, ".obj"))
  }

  ### Create Figure
  # Get Information
  g1 <- ggplotGrob(figures[[1]])
  id.legend <- grep("guide", g1$layout$name)
  legend <- g1[["grobs"]][[id.legend]]


  # Edit Figure
  edit_figure <- theme(legend.position="none",
                       axis.title.x=element_blank(),
                       axis.title.y=element_blank(),
                       axis.text.x=element_blank(),
                       axis.text.y=element_blank())
  figures <- lapply(figures, function(x){x + edit_figure})

  # New Pictures cf. https://stackoverflow.com/a/11093069/4357279
  g <- arrangeGrob(grobs=figures, 
               nrow = length(estimatedK),
               right = legend,
               top = textGrob(title_),
               left = textGrob("Estimated Topic", rot = 90, vjust = 1),
               bottom = textGrob("True Topic", vjust = -0.1))

  grid.draw(g) # Show plot
}

multiple_simulations <- function(trueK,
                                 estimatedK,
                                 seed_only=F,
                                 seed_contamination=0){

  # Run Simulation
  run_simulations(trueK, estimatedK, seed_only=seed_only, seed_contamination=seed_contamination)

  # Create Figure
  create_simulation_figure(trueK, estimatedK)
}
```


```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
# How many "true" topic can keywords collect?
multiple_simulations(trueK=c(5,15,25,35), estimatedK=c(5,15,25,35))
```

```{r, warning=FALSE, message=FALSE, fig.width=8.5, fig.height=6.5}
# How many "true" topic can keywords collect?
multiple_simulations(trueK=c(5,15,25,35), estimatedK=c(5,15,25,35),
                     seed_contamination=2)
```
