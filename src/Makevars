# Makevars for keyATM with OpenMP optimization

# Compiler flags
CXX_STD = CXX17

# OpenMP flags (platform-specific)
UNAME_S := $(shell uname -s)

ifeq ($(UNAME_S),Darwin)
    # macOS with Homebrew LLVM
    LLVM_PATH = $(shell brew --prefix llvm 2>/dev/null)
    ifneq ($(LLVM_PATH),)
        PKG_CXXFLAGS += -I$(LLVM_PATH)/include -fopenmp
        PKG_LIBS += -L$(LLVM_PATH)/lib -lomp
    else
        # Fallback for systems without Homebrew LLVM
        PKG_CXXFLAGS += -Xclang -fopenmp
        PKG_LIBS += -lomp
    endif
else
    # Linux and other Unix systems
    PKG_CXXFLAGS += -fopenmp
    PKG_LIBS += -fopenmp
endif

# Optimization flags
PKG_CXXFLAGS += -O3 -march=native -ffast-math
PKG_CXXFLAGS += -DEIGEN_NO_DEBUG -DEIGEN_DONT_PARALLELIZE
PKG_CXXFLAGS += -DEIGEN_USE_BLAS -DEIGEN_USE_LAPACKE

# Additional performance flags
PKG_CXXFLAGS += -funroll-loops -finline-functions
PKG_CXXFLAGS += -fomit-frame-pointer

# Link with optimized BLAS/LAPACK if available
PKG_LIBS += $(LAPACK_LIBS) $(BLAS_LIBS) $(FLIBS)

# Disable some warnings that may occur with optimization
PKG_CXXFLAGS += -Wno-unused-variable -Wno-unused-function