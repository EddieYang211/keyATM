---
title: "Estimate the effect of covariates"
output: 
  html_document:
    toc: true
---

```{r setup II, include=FALSE, eval=TRUE}
knitr::opts_chunk$set(eval = T, echo = TRUE)
```

```{r, warning=FALSE, message=FALSE, fig.align='center', include = FALSE}
library(keyATM)
data(keyATM_data_bills)
bills_cov <- keyATM_data_bills$cov
dim(bills_cov)  # We have 140 documents and a single covariate

bills_time_index <- keyATM_data_bills$time_index
bills_time_index <- as.integer(bills_time_index - 100)

library(quanteda)
bills_dfm <- keyATM_data_bills$doc_dfm  # quanteda object
keyATM_docs <- keyATM_read(bills_dfm)

bills_keywords <- list(
                       Education = c("education", "child", "student"),
                       Law       = c("court", "law", "attorney"),
                       Health    = c("public", "health", "program"),
                       Drug      = c("drug", "treatment")
                      )
```

## Topic-Word distribution by covariates
```{r, warning=FALSE, message=FALSE, fig.align='center'}
out <- keyATM(
              docs              = keyATM_docs,    # text input
              no_keyword_topics = 3,              # number of topics without keywords
              keywords          = bills_keywords, # keywords
              model             = "base",         # select the model
              options           = list(seed = 100),
              keep              = c("Z")          # You need to keep `Z`
             )
```

We have a binary variable of the party ID of bill's proposer. `0` indicates Democrat and `1` indicates Republican.
```{r, warning=FALSE, message=FALSE, fig.align='center'}
table(bills_cov[, "RepParty"])
```

`by_strata_TopicWord()` function calculates topic-word distribution subsetted by a vector provided.
```{r, warning=FALSE, message=FALSE, fig.align='center'}
RepParty <- as.vector(bills_cov[, "RepParty"])  # the length should be the same as the number of documents
strata_tw <- by_strata_TopicWord(out, keyATM_docs, by = RepParty)
```

You can get top words with `top_words()`.
```{r, warning=FALSE, message=FALSE, fig.align='center'}
top_words(strata_tw, n = 5)
```

As long as the length is the same as the number of documents, you can use a character vector for `by` argument argument.
```{r, warning=FALSE, message=FALSE, fig.align='center'}
RepParty_chr <- ifelse(bills_cov[, "RepParty"] == 0, "Democrat", "Republican")
strata_tw_chr <- by_strata_TopicWord(out, keyATM_docs, RepParty_chr)
top_words(strata_tw_chr)
```


```{r, warning=FALSE, message=FALSE, fig.align='center'}
out2 <- keyATM(
               docs              = keyATM_docs,    # text input
               no_keyword_topics = 3,              # number of topics without keywords
               keywords          = bills_keywords, # keywords
               model             = "covariates",   # select the model
               model_settings    = list(covariates_data = bills_cov,
                                        covariates_formula = ~ RepParty),
               options           = list(seed = 100, store_theta = TRUE)
              )

out3 <- keyATM(
               docs              = keyATM_docs,    # text input
               no_keyword_topics = 3,              # number of topics without keywords
               keywords          = bills_keywords, # keywords
               model             = "dynamic",          # select the model
               model_settings    = list(time_index = bills_time_index,
                                        num_states = 5),
               options           = list(seed = 100, store_theta = TRUE)
              )
```

## Regressing document topic proportion on covariates
```{r, warning=FALSE, message=FALSE, fig.align='center'}
coef <- estimate_coefficients(out1, covariates_data = bills_cov,
                              covariates_formula = ~ RepParty)
plot(coef, topics = 1:3, variables = c("RepParty"))
```


```{r, warning=FALSE, message=FALSE, fig.align='center'}
coef <- estimate_coefficients(out2,
                              covariates_data = bills_cov,
                              covariates_formula = ~ RepParty)
plot(coef, topics = 1:3, variables = c("RepParty"))
```


```{r, warning=FALSE, message=FALSE, fig.align='center'}
coef <- estimate_coefficients(out3,
                              covariates_data = bills_cov,
                              covariates_formula = ~ RepParty)
plot(coef, topics = 1:3, variables = c("RepParty"))
```


