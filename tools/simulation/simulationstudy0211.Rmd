---
title: "Simulation Study"
author: "Shusei Eshima"
date: "`r Sys.Date()`"
output:
 rmarkdown::html_vignette:
 toc: yes
vignette: >
  %\VignetteIndexEntry{SimulationStudy}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Set Chunk Options

```{r warning=FALSE, message=FALSE}
library(knitr)
knitr::opts_chunk$set(comment = "")
```

# Preparation

## Prepare Packages

```{r, message=FALSE}
setwd("/Users/Shusei/Dropbox/Study/Project/ImaiText/topicdict/tools/simulation")
source("simdata_call.R")
library(topicdict)
library(tidyverse)
library(quanteda)
num_iteration <- 1000
```

## Define a function
Run simulation code:
```{r, warning=FALSE, message=FALSE}
show_true_seed <- function(data_folder_name, seed_file_name = "SeedWords.csv"){
  seed_file <- paste0(data_folder, data_folder_name, "/", seed_file_name)
  true_seed <- invisible(readr::read_csv(seed_file))
  message("Row: Topic / Column: Seed word")
  print(true_seed)
}


topicdict_simulation_run <- function(data_folder_name, iter, extra_k, 
                                     seed_file_name="SeedWords.csv", seed_list = NULL,
                                     cull_seed=NULL){

  # cull_seed: Which row (=topic) and column (=number of seed) to use

  set.seed(225)

  folder <- paste0(data_folder, data_folder_name, "/W")
  docs <- list.files(folder, pattern = "*.txt", full.names = TRUE)

  seed_file <- paste0(data_folder, data_folder_name, "/", seed_file_name)

  seeddata <- invisible(readr::read_csv(seed_file))

  if(!is.null(cull_seed)){
    seeddata <- seeddata[1:cull_seed[1], 1:cull_seed[2]]
  }

  if(is.null(seed_list)){
    seed_list <- as.list( apply(seeddata, 1, function(x){return(paste0(x, collapse=" "))}) )
  }
  names(seed_list) <- 1:length(seed_list)
  dict <- quanteda::dictionary(seed_list)

  model <- topicdict_model(docs,
               dict = dict, extra_k = extra_k,
               remove_numbers = FALSE, # For simulation, make it false
               remove_punct = TRUE,
               remove_symbols = TRUE,
               remove_separators = TRUE)

  res <- topicdict_train(model, iter = iter)
  
  return(res)
}
```

Visualization:
```{r, warning=FALSE, message=FALSE}
diagnosis_topic_recovery <- function(post, n=25){
  topwords <- top_terms(post, n=n)
  topwords <- data.frame(topwords)
  colnames(topwords) <- paste0("EstTopic", 1:ncol(topwords))

  topwords <- tidyr::gather(topwords, key=EstTopic, value=Word)

  topwords %>%
    mutate(RawWord = Word) %>%
    separate(Word,
        into=c("TrueTopic", "word_id"),
        sep="r|s") %>%
    mutate(TrueTopic = paste0("True", as.character(TrueTopic))) %>%
    group_by(EstTopic, TrueTopic) %>%
    summarise(counts = n()) %>%
    ungroup() %>%
    group_by(EstTopic) %>% 
    mutate(topicsum = sum(counts)) %>%
    ungroup() %>%
    mutate(Proportion = counts / topicsum * 100,
           Estimated = EstTopic) -> res

    num <- length(unique(res$Estimated))
    truenum <- length(unique(res$TrueTopic))

    title <- paste0("Top ", as.character(n), " words")

    g <- ggplot(res, aes(x=Estimated, y=Proportion, fill=TrueTopic)) +
          geom_bar(stat="identity") +
          scale_x_discrete(limits = rev(paste0("EstTopic", 1:num))) +
          coord_flip() +
          scale_fill_hue(name = "True Topics", breaks=paste0("True", 1:truenum)) + 
          xlab("Estimated Topics") + ylab("Proportion (%)") + theme_bw(base_size=16) +
          ggtitle(title) +
          theme(plot.title = element_text(hjust = 0.5))

    return(g)
}

diagnosis_topic_recovery_heatmap <- function(post, n=25){
  topwords <- top_terms(post, n=n)
  topwords <- data.frame(topwords)
  colnames(topwords) <- paste0("EstTopic", 1:ncol(topwords))

  topwords <- tidyr::gather(topwords, key=EstTopic, value=Word)

  topwords %>%
    mutate(RawWord = Word) %>%
    separate(Word,
        into=c("TrueTopic", "word_id"),
        sep="r|s") %>%
    mutate(TrueTopic = paste0("True", as.character(TrueTopic))) %>%
    group_by(EstTopic, TrueTopic) %>%
    summarise(counts = n()) %>%
    ungroup() %>%
    group_by(EstTopic) %>% 
    mutate(topicsum = sum(counts)) %>%
    ungroup() %>%
    mutate(Proportion = counts / topicsum * 100,
           Estimated = EstTopic) -> res

    num <- length(unique(res$Estimated))
    truenum <- length(unique(res$TrueTopic))

    title <- paste0("Seeded LDA: Top ", as.character(n), " words")

    g <- ggplot(res, aes(EstTopic, TrueTopic)) +
          geom_tile(aes(fill=Proportion)) + 
          scale_fill_gradient(limits=c(0, 100), low="#e8e8e8", high="#0072B2") +
          scale_x_discrete(limits = rev(paste0("EstTopic", 1:num))) +
          coord_flip() +
          scale_y_discrete(limits = paste0("True", 1:truenum)) +
          xlab("Estimated Topics") + ylab("True Topic") + theme_bw(base_size=13) +
          ggtitle(title) +
          theme(plot.title = element_text(hjust = 0.5))

    return(g)
}
```

LDA
```{r, warning=FALSE, message=FALSE}
library(topicmodels)
library(tidytext)
library(tm)

get_lda_result <- function(data_folder_name, iter, k, show_n=25){
  folder <- paste0(data_folder, data_folder_name, "/W")

  # Prepare Data
  corpus <- Corpus(DirSource(folder))
  strsplit_space_tokenizer <- function(x)
      unlist(strsplit(as.character(x), "[[:space:]]+"))

  dtm <- DocumentTermMatrix(corpus,
                           control = list(tokenize=strsplit_space_tokenizer, 
                           stopwords = F, tolower = F, 
                           stemming = F, wordLengths = c(1, Inf)))

  lda <- LDA(dtm, k = k, control = list(seed = 225, iter=iter), method="Gibbs")

  assign <- augment(lda, dtm)
  assign %>% 
        mutate(Word=term) %>%
        separate(term,
                into=c("True", "raw_word_id"),
                sep="S|R") %>%
        mutate(TrueTopic = paste0("True", as.character(True))) %>%
        group_by(.topic, TrueTopic, Word) %>%
        summarise(counts = sum(count)) %>%
        ungroup() %>%
				group_by(.topic) %>%
        top_n(show_n, counts) %>%
				ungroup() %>%
				group_by(.topic, TrueTopic) %>%
				summarise(counts = sum(counts)) %>%
        ungroup() %>%
				group_by(.topic) %>%
				mutate(topicsum = sum(counts)) %>%
				ungroup() %>%
        mutate(Proportion = counts / topicsum * 100,
               EstTopic = paste0("EstTopic", .topic)) -> res

  num <- length(unique(res$EstTopic))
  truenum <- length(unique(res$TrueTopic))
  title <- paste0("LDA: Top ", as.character(show_n), " words")

  g <- ggplot(res, aes(EstTopic, TrueTopic)) +
        geom_tile(aes(fill=Proportion)) + 
        scale_fill_gradient(limits=c(0, 100), low="#e8e8e8", high="#0072B2") +
        scale_x_discrete(limits = rev(paste0("EstTopic", 1:num))) +
        coord_flip() +
        scale_y_discrete(limits = paste0("True", 1:truenum)) +
        xlab("Estimated Topics") + ylab("True Topic") + theme_bw(base_size=13) +
        ggtitle(title) +
        theme(plot.title = element_text(hjust = 0.5))

  return(g)
}
```

# Simulation

## Simulation 1 (numtopic = 15, flat alpha)
```{r, warning=FALSE, message=FALSE, fig.width=5, fig.height=5}
data_folder <- tempfile()
create_sim_data(saveDir=paste0(data_folder, "Sim1"), D=1000, K=15, TotalV=3000, alpha=0.1, beta_r=0.1, beta_s=0.1, p=rep(0.2, 15), lambda=200, seeds_len=5)
```

### Split True Seed, number of topics is truth
```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
# show_true_seed("Sim1")
seed_list <- list(c("1S3 1S140"),
                 c("1S42 1S154"),
                 c("3S42 3S75 3S83"),
                 c("4S11 4S200 4S97"))

res <- topicdict_simulation_run("Sim1", seed_list=seed_list, iter=num_iteration, extra_k=11)
post <- topicdict::posterior(res)
diagnosis_alpha(post, start=5, show_topic=c(1,2,3,4), true_vec=rep(0.1, 15))
```

```{r, warning=FALSE, message=FALSE, fig.width=6, fig.height=4}
diagnosis_model_fit(post, start=2)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=8}
# diagnosis_topic_recovery(post)
```

```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=6.5}
diagnosis_topic_recovery_heatmap(post)
```


### Split True Seed, underestimated number of topics 
```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
# show_true_seed("Sim1")
seed_list <- list(c("1S3 1S140"),
                 c("1S42 1S154"),
                 c("3S42 3S75 3S83"),
                 c("4S11 4S200 4S97"))

res <- topicdict_simulation_run("Sim1", seed_list=seed_list, iter=num_iteration, extra_k=8)
post <- topicdict::posterior(res)
diagnosis_alpha(post, start=5, show_topic=c(1,2,3,4), true_vec=rep(0.1, 15))
```

```{r, warning=FALSE, message=FALSE, fig.width=6, fig.height=4}
diagnosis_model_fit(post, start=2)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=8}
# diagnosis_topic_recovery(post)
```

```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=6.5}
diagnosis_topic_recovery_heatmap(post)
```

### Split True Seed, overestimated number of topics 
```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
# show_true_seed("Sim1")
seed_list <- list(c("1S3 1S140"),
                 c("1S42 1S154"),
                 c("3S42 3S75 3S83"),
                 c("4S11 4S200 4S97"))

res <- topicdict_simulation_run("Sim1", seed_list=seed_list, iter=num_iteration, extra_k=15)
post <- topicdict::posterior(res)
diagnosis_alpha(post, start=5, show_topic=c(1,2,3,4), true_vec=rep(0.1, 15))
```

```{r, warning=FALSE, message=FALSE, fig.width=6, fig.height=4}
diagnosis_model_fit(post, start=2)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=8}
# diagnosis_topic_recovery(post)
```

```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=6.5}
diagnosis_topic_recovery_heatmap(post)
```

### Merge True Seed, number of topics is truth
```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
# show_true_seed("Sim1")
seed_list <- list(c("1S3 1S140 1S42"),
                 c("2S190 2S163 3S42 3S75"),
                 c("4S11 4S200 6S200"))

res <- topicdict_simulation_run("Sim1", seed_list=seed_list, iter=num_iteration, extra_k=12)
post <- topicdict::posterior(res)
diagnosis_alpha(post, start=5, show_topic=c(1,2,3,4), true_vec=rep(0.1, 15))
```

```{r, warning=FALSE, message=FALSE, fig.width=6, fig.height=4}
diagnosis_model_fit(post, start=2)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=8}
# diagnosis_topic_recovery(post)
```

```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=6.5}
diagnosis_topic_recovery_heatmap(post)
```


### Merge True Seed, underestimated number of topics 
```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
# show_true_seed("Sim1")
seed_list <- list(c("1S3 1S140 1S42"),
                 c("2S190 2S163 3S42 3S75"),
                 c("4S11 4S200 6S200"))

res <- topicdict_simulation_run("Sim1", seed_list=seed_list, iter=num_iteration, extra_k=8)
post <- topicdict::posterior(res)
diagnosis_alpha(post, start=5, show_topic=c(1,2,3,4), true_vec=rep(0.1, 15))
```

```{r, warning=FALSE, message=FALSE, fig.width=6, fig.height=4}
diagnosis_model_fit(post, start=2)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=8}
# diagnosis_topic_recovery(post)
```

```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=6.5}
diagnosis_topic_recovery_heatmap(post)
```

### Merge True Seed, overestimated number of topics 
```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
# show_true_seed("Sim1")
seed_list <- list(c("1S3 1S140 1S42"),
                 c("2S190 2S163 3S42 3S75"),
                 c("4S11 4S200 6S200"))

res <- topicdict_simulation_run("Sim1", seed_list=seed_list, iter=num_iteration, extra_k=15)
post <- topicdict::posterior(res)
diagnosis_alpha(post, start=5, show_topic=c(1,2,3,4), true_vec=rep(0.1, 15))
```

```{r, warning=FALSE, message=FALSE, fig.width=6, fig.height=4}
diagnosis_model_fit(post, start=2)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=8}
# diagnosis_topic_recovery(post)
```

```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=6.5}
diagnosis_topic_recovery_heatmap(post)
```

### Best LDA result (true number of topics)
```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=6.5}
get_lda_result("Sim1", iter=num_iteration, k=15)
```

### Best Seeded LDA result
```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
res <- topicdict_simulation_run("Sim1", iter=num_iteration, extra_k=10, cull_seed=c(5, 3))
post <- topicdict::posterior(res)
diagnosis_alpha(post, start=5, show_topic=c(1,2,3,4), true_vec=rep(0.1, 15))
```

```{r, warning=FALSE, message=FALSE, fig.width=6, fig.height=4}
diagnosis_model_fit(post, start=2)
```

```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=6.5}
diagnosis_topic_recovery_heatmap(post)
```


## Simulation 2 (numtopic = 10, uneven alpha)
```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
data_folder <- tempfile()
alpha_vec <- c(0.1, 0.2, 0.3, 0.1, 0.2, 0.3, 0.1, 0.2, 0.3, 0.1)
create_sim_data(saveDir=paste0(data_folder, "Sim2"), D=1000, K=10, TotalV=3000, alpha=alpha_vec, beta_r=0.1, beta_s=0.1, p=rep(0.2, 10), lambda=200, seeds_len=5)
```

### Split True Seed, number of topics is truth
```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
# show_true_seed("Sim2")
seed_list <- list(c("1S4 1S210"),
                 c("1S63 1S232"),
                 c("3S63 3S113 3S118"),
                 c("4S16 4S17 4S146"))
res <- topicdict_simulation_run("Sim2", seed_list=seed_list, iter=num_iteration, extra_k=6)
post <- topicdict::posterior(res)
diagnosis_alpha(post, start=5, show_topic=c(1,2,3), true_vec=alpha_vec)
```

```{r, warning=FALSE, message=FALSE, fig.width=6, fig.height=4}
diagnosis_model_fit(post, start=2)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=8}
# diagnosis_topic_recovery(post)
```

```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=6.5}
diagnosis_topic_recovery_heatmap(post)
```

### Merge True Seed, number of topics is truth
```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
# show_true_seed("Sim2")
seed_list <- list(c("1S4 1S210"),
                 c("2S284 2S245 5S184 5S192"),
                 c("3S63 3S113 3S118"),
                 c("4S16 4S17 4S146"))
res <- topicdict_simulation_run("Sim2",seed_list=seed_list, iter=num_iteration, extra_k=6)
post <- topicdict::posterior(res)
diagnosis_alpha(post, start=5, show_topic=c(1,2,3), true_vec=alpha_vec)
```

```{r, warning=FALSE, message=FALSE, fig.width=6, fig.height=4}
diagnosis_model_fit(post, start=2)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=8}
# diagnosis_topic_recovery(post)
```

```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=6.5}
diagnosis_topic_recovery_heatmap(post)
```

### Best LDA result (true number of topics)
```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=6.5}
get_lda_result("Sim2", iter=num_iteration, k=10)
```

### Best Seeded LDA result
```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
res <- topicdict_simulation_run("Sim2", iter=num_iteration, extra_k=5, cull_seed=c(5, 3))
post <- topicdict::posterior(res)
diagnosis_alpha(post, start=5, show_topic=c(1,2,3,4), true_vec=alpha_vec)
```

```{r, warning=FALSE, message=FALSE, fig.width=6, fig.height=4}
diagnosis_model_fit(post, start=2)
```

```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=6.5}
diagnosis_topic_recovery_heatmap(post)
```


## Simulation 3 (numtopic = 15, flat alpha, uneven p)
```{r, warning=FALSE, message=FALSE, fig.width=5, fig.height=5}
data_folder <- tempfile()
p_vec <- c(0.01, 0.03, 0.05, 0.1, rep(0.2, 11))
create_sim_data(saveDir=paste0(data_folder, "Sim3"), D=1000, K=15, TotalV=3000, alpha=0.1, beta_r=0.1, beta_s=0.1, p=p_vec, lambda=200, seeds_len=5)
```

### Split True Seed, number of topics is truth
```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
# show_true_seed("Sim3")
seed_list <- list(c("1S3 1S140"),
                 c("1S42 1S154"),
                 c("3S42 3S75 3S83"),
                 c("4S11 4S200 4S97"))
res <- topicdict_simulation_run("Sim3", seed_list=seed_list, iter=num_iteration, extra_k=11)
post <- topicdict::posterior(res)
diagnosis_alpha(post, start=5, show_topic=c(1,2,3,4), true_vec=rep(0.1, 15))
```

```{r, warning=FALSE, message=FALSE, fig.width=6, fig.height=4}
diagnosis_model_fit(post, start=2)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=8}
# diagnosis_topic_recovery(post)
```

```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=6.5}
diagnosis_topic_recovery_heatmap(post)
```

### Merge True Seed, number of topics is truth
```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
# show_true_seed("Sim3")
seed_list <- list(c("1S3 1S140 1S42"),
                 c("2S190 2S163 5S123 5S128"),
                 c("3S42 3S75 3S83"),
                 c("4S11 4S200 4S97"))
res <- topicdict_simulation_run("Sim3", seed_list=seed_list, iter=num_iteration, extra_k=11)
post <- topicdict::posterior(res)
diagnosis_alpha(post, start=5, show_topic=c(1,2,3,4), true_vec=rep(0.1, 15))
```

```{r, warning=FALSE, message=FALSE, fig.width=6, fig.height=4}
diagnosis_model_fit(post, start=2)
```

```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=8}
# diagnosis_topic_recovery(post)
```

```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=6.5}
diagnosis_topic_recovery_heatmap(post)
```

### Best LDA result (true number of topics)
```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=6.5}
get_lda_result("Sim3", iter=num_iteration, k=15)
```

### Best Seeded LDA result
```{r, warning=FALSE, message=FALSE, fig.width=7, fig.height=6}
res <- topicdict_simulation_run("Sim3", iter=num_iteration, extra_k=10, cull_seed=c(5, 3))
post <- topicdict::posterior(res)
diagnosis_alpha(post, start=5, show_topic=c(1,2,3,4), true_vec=alpha_vec)
```

```{r, warning=FALSE, message=FALSE, fig.width=6, fig.height=4}
diagnosis_model_fit(post, start=2)
```

```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=6.5}
diagnosis_topic_recovery_heatmap(post)
```
